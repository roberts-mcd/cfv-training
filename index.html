<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roberts Management - Customer First Visit Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FFC72C 0%, #DA291C 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .main-content {
            padding: 30px;
        }

        .login-screen, .dashboard, .training-screen, .leaderboard-screen {
            display: none;
        }

        .login-screen.active, .dashboard.active, .training-screen.active, .leaderboard-screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #FFC72C;
        }

        .btn {
            background: linear-gradient(135deg, #FFC72C 0%, #DA291C 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .training-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .section-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
        }

        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #FFC72C;
        }

        .section-card h3 {
            color: #DA291C;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #FFC72C;
        }

        .question-card h4 {
            color: #DA291C;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .options {
            margin-top: 15px;
        }

        .option {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #FFC72C;
            background: #fff8e1;
        }

        .option.selected {
            border-color: #DA291C;
            background: #ffebee;
        }

        .option.correct {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .option.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }

        .leaderboard-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #FFC72C 0%, #DA291C 100%);
            color: white;
            padding: 15px;
            text-align: left;
        }

        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard-table tr:hover {
            background: #f5f5f5;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            color: white;
        }

        .rank-1 { background: gold; color: #333; }
        .rank-2 { background: silver; color: #333; }
        .rank-3 { background: #cd7f32; }

        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 12px;
            margin: 20px 0;
        }

        .score-display h2 {
            font-size: 3em;
            margin: 20px 0;
        }

        .score-display.fail {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .checkpoint-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .restaurant-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .restaurant-olympia { background: #e3f2fd; color: #1976d2; }
        .restaurant-peters { background: #f3e5f5; color: #7b1fa2; }
        .restaurant-duquesne { background: #e8f5e9; color: #388e3c; }
        .restaurant-waterfront { background: #fff3e0; color: #f57c00; }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .training-sections {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçî Roberts Management</h1>
            <p>Customer First Visit Training System</p>
        </div>

        <div class="main-content">
            <!-- Login Screen -->
            <div class="login-screen active" id="loginScreen">
                <h2 style="margin-bottom: 20px; color: #DA291C;">Welcome! Please Sign In</h2>
                <div class="form-group">
                    <label for="userName">Your Name:</label>
                    <input type="text" id="userName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="userRestaurant">Your Restaurant:</label>
                    <select id="userRestaurant">
                        <option value="">Select Restaurant</option>
                        <option value="Olympia">Olympia</option>
                        <option value="Peters">Peters</option>
                        <option value="Duquesne">Duquesne</option>
                        <option value="Waterfront">Waterfront</option>
                    </select>
                </div>
                

                
                <button class="btn" onclick="login()">Start Training</button>
            </div>

            <!-- Dashboard -->
            <div class="dashboard" id="dashboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #DA291C;">Training Dashboard</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="showLeaderboard()">üèÜ Leaderboard</button>
                        <button class="btn" onclick="logout()">Logout</button>
                    </div>
                </div>

                <div class="info-box">
                    <strong>Welcome, <span id="dashboardUserName"></span>!</strong>
                    <span id="dashboardRestaurant" class="restaurant-badge"></span>
                    <p style="margin-top: 10px;">Select a section below to begin your training. Pass score: 80% or higher.</p>
                </div>

                <div id="syncStatus"></div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Overall Progress</h4>
                        <div class="value" id="overallProgress">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Sections Completed</h4>
                        <div class="value" id="sectionsCompleted">0/4</div>
                    </div>
                    <div class="stat-card">
                        <h4>Average Score</h4>
                        <div class="value" id="averageScore">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Your Rank</h4>
                        <div class="value" id="userRank">-</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0; color: #333;">Training Sections</h3>
                <div class="training-sections">
                    <div class="section-card" onclick="startTraining('driveThru')">
                        <h3>üöó Drive Thru</h3>
                        <p style="color: #666; margin: 10px 0;">56 Points Total</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-driveThru" style="width: 0%">0%</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em;" id="score-driveThru">Not Started</p>
                    </div>

                    <div class="section-card" onclick="startTraining('inRestaurant')">
                        <h3>üè™ In-Restaurant</h3>
                        <p style="color: #666; margin: 10px 0;">61 Points Total</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-inRestaurant" style="width: 0%">0%</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em;" id="score-inRestaurant">Not Started</p>
                    </div>

                    <div class="section-card" onclick="startTraining('curbside')">
                        <h3>üÖøÔ∏è Curbside</h3>
                        <p style="color: #666; margin: 10px 0;">52 Points Total</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-curbside" style="width: 0%">0%</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em;" id="score-curbside">Not Started</p>
                    </div>

                    <div class="section-card" onclick="startTraining('delivery')">
                        <h3>üõµ Delivery</h3>
                        <p style="color: #666; margin: 10px 0;">32 Points Total</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-delivery" style="width: 0%">0%</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em;" id="score-delivery">Not Started</p>
                    </div>
                </div>
            </div>

            <!-- Training Screen -->
            <div class="training-screen" id="trainingScreen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #DA291C;" id="trainingTitle">Training</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="saveProgress()">üíæ Save Progress</button>
                        <button class="btn" onclick="exitTraining()">‚Üê Back to Dashboard</button>
                    </div>
                </div>

                <div class="checkpoint-info">
                    <strong>Progress:</strong> Question <span id="currentQuestion">1</span> of <span id="totalQuestions">0</span>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" id="quizProgress" style="width: 0%">0%</div>
                    </div>
                </div>

                <div id="questionContainer"></div>

                <div class="quiz-navigation">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" disabled>‚Üê Previous</button>
                    <button class="btn" id="nextBtn" onclick="nextQuestion()">Next ‚Üí</button>
                    <button class="btn btn-success" id="submitBtn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div class="leaderboard-screen" id="leaderboardScreen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #DA291C;">üèÜ Leaderboard</h2>
                    <button class="btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
                </div>

                <div class="filter-section">
                    <label for="leaderboardFilter" style="margin-right: 10px;"><strong>Filter by:</strong></label>
                    <select id="leaderboardFilter" onchange="updateLeaderboard()">
                        <option value="all">All Restaurants</option>
                        <option value="Olympia">Olympia</option>
                        <option value="Peters">Peters</option>
                        <option value="Duquesne">Duquesne</option>
                        <option value="Waterfront">Waterfront</option>
                    </select>
                    <select id="sectionFilter" onchange="updateLeaderboard()" style="margin-left: 10px;">
                        <option value="overall">Overall Score</option>
                        <option value="driveThru">Drive Thru</option>
                        <option value="inRestaurant">In-Restaurant</option>
                        <option value="curbside">Curbside</option>
                        <option value="delivery">Delivery</option>
                    </select>
                </div>

                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Restaurant</th>
                            <th>Score</th>
                            <th>Completed</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - GOOGLE SHEETS URL
        // ============================================
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbz9h0sFexS2TbyKQAPlTDOjQyQKUbz1y-TzT_fPWgjGO8M2YtpCXrOqaADZBP3kidc/exec";
        // ============================================

        // Training Questions Database
        const trainingData = {
            driveThru: {
                title: "Drive Thru",
                totalPoints: 56,
                questions: [
                    {
                        id: "DT1",
                        question: "DT1-US Cleanliness: What must be clean and free of litter?",
                        points: 3,
                        options: [
                            "Only the parking lot",
                            "Only the menu boards and windows",
                            "The exterior of the restaurant including parking lot, landscape, sidewalks, trash receptacles, corral area, signage, menu boards, and windows",
                            "Just the drive-thru lane"
                        ],
                        correct: 2,
                        explanation: "The exterior must be comprehensively clean including parking lot, landscape, sidewalks, trash receptacles, corral area, external signage, menu boards, and windows."
                    },
                    {
                        id: "DT2",
                        question: "DT2-US Cleanliness: What is required for crew and manager uniforms?",
                        points: 3,
                        options: [
                            "Any clothing is acceptable",
                            "Uniforms must be clean and in good condition (not dirty, stained, wrinkled, or torn)",
                            "Only the shirt needs to be clean",
                            "Uniforms can have minor stains"
                        ],
                        correct: 1,
                        explanation: "Crew and managers must wear uniforms that are clean and in good condition - not dirty, stained, wrinkled, or torn/ripped."
                    },
                    {
                        id: "DT3",
                        question: "DT3-US Order: Within how many seconds should a prompt greeting be provided?",
                        points: 2,
                        options: [
                            "5 seconds",
                            "10 seconds",
                            "15 seconds",
                            "20 seconds"
                        ],
                        correct: 1,
                        explanation: "A prompt greeting must be provided within 10 seconds at the order point."
                    },
                    {
                        id: "DT3-01",
                        question: "DT3-US-01 Order: What should the Order Taker ask and do?",
                        points: 2,
                        options: [
                            "Just take the order",
                            "Ask if using McDonald's App and acknowledge customer by name",
                            "Only ask about payment method",
                            "Just verify the order"
                        ],
                        correct: 1,
                        explanation: "Order Taker should ask if the customer is using the McDonald's App and acknowledge them by name (digital prompt and use of name)."
                    },
                    {
                        id: "DT4",
                        question: "DT4-US Pay: What is required at the payment window?",
                        points: 4,
                        options: [
                            "Just collect payment",
                            "Prompt greeting, friendly interaction, use customer's name, proper cashless procedures, thank customer, provide receipt, focus on customer, and clear instructions",
                            "Only give receipt",
                            "Just say thank you"
                        ],
                        correct: 1,
                        explanation: "At payment: prompt greeting, friendly interaction, use customer's name, follow cashless procedures, thank customer, provide receipt, stay focused on customer, and give clear instructions."
                    },
                    {
                        id: "DT5",
                        question: "DT5-US Present: What are the 3 W's if a car is pulled forward?",
                        points: 4,
                        options: [
                            "What, When, Where",
                            "Why, Wait time, Where",
                            "Who, What, When",
                            "Why, What, Where"
                        ],
                        correct: 1,
                        explanation: "If pulled forward, explain the 3 W's: WHY they are waiting, WAIT time expected, and WHERE to pull forward to."
                    },
                    {
                        id: "DT6",
                        question: "DT6-US Speed: What is the Line Time standard?",
                        points: 4,
                        options: [
                            "60 seconds or less",
                            "70 seconds or less",
                            "90 seconds or less",
                            "120 seconds or less"
                        ],
                        correct: 1,
                        explanation: "Line Time should be 70 seconds or less (from 3rd car behind order point to arrival at order point)."
                    },
                    {
                        id: "DT7",
                        question: "DT7-US Speed: What is the OEPE (Order End Present End) time standard for full points?",
                        points: 8,
                        options: [
                            "90 seconds or less",
                            "100 seconds or less",
                            "120 seconds or less",
                            "140 seconds or less"
                        ],
                        correct: 2,
                        explanation: "OEPE should be 120 seconds or less for full 8 points (starts when order-taking complete, ends when last item presented)."
                    },
                    {
                        id: "DT9",
                        question: "DT9-US Accuracy: What constitutes proper order accuracy?",
                        points: 8,
                        options: [
                            "Just getting the main item right",
                            "Receiving all food and drink items as ordered and properly prepared",
                            "Close enough is good enough",
                            "Only the sandwich needs to be correct"
                        ],
                        correct: 1,
                        explanation: "All food and drink items must be received as ordered AND properly prepared (correct ingredients, not underfilled)."
                    },
                    {
                        id: "DT10",
                        question: "DT10-US Accuracy: What must be included with the order?",
                        points: 4,
                        options: [
                            "Just napkins",
                            "Condiments (if required/requested), utensils, napkins, and straws",
                            "Only straws and napkins",
                            "Whatever is available"
                        ],
                        correct: 1,
                        explanation: "Orders must include condiments (if required/requested), utensils, napkins, and straws. Note: Some municipalities require condiments to be requested."
                    },
                    {
                        id: "DT11",
                        question: "DT11-US Quality: What are the sandwich/entr√©e quality standards?",
                        points: 6,
                        options: [
                            "Just needs to be hot",
                            "Served neat, at proper temperature, fresh, and tastes good",
                            "Temperature doesn't matter",
                            "Appearance is not important"
                        ],
                        correct: 1,
                        explanation: "Sandwiches must be: neat, at proper temperature, fresh, and taste good. Includes proper bun quality, ingredient distribution, and protein quality."
                    },
                    {
                        id: "DT12",
                        question: "DT12-US Quality: What are the french fry quality standards?",
                        points: 4,
                        options: [
                            "Just hot",
                            "Hot, salted, crisp, and taste good (or hash browns hot, crisp, good taste)",
                            "Temperature only matters",
                            "Salt level doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Fries must be hot, properly salted, crisp, and taste good. Hash browns must be hot, crisp, and taste good."
                    },
                    {
                        id: "DT13",
                        question: "DT13-US Quality: What are the beverage quality standards?",
                        points: 2,
                        options: [
                            "Any temperature is fine",
                            "Served neat, at proper temperature, and tastes good (cold drinks must be cold/with ice where applicable)",
                            "Appearance doesn't matter",
                            "Ice is optional for cold drinks"
                        ],
                        correct: 1,
                        explanation: "Drinks must be neat, at proper temperature, and taste good. Cold drinks must be cold and served with ice where applicable. Must not be expired."
                    },
                    {
                        id: "DT14",
                        question: "DT14-US-01 Quality: What are dessert quality standards?",
                        points: 2,
                        options: [
                            "Just not melted",
                            "Served neat, at proper temperature, tastes good, and within holding time (not expired)",
                            "Temperature doesn't matter for desserts",
                            "Appearance is not important"
                        ],
                        correct: 1,
                        explanation: "Desserts must be neat, at proper temperature, taste good, and be within holding time (not expired)."
                    }
                ]
            },
            inRestaurant: {
                title: "In-Restaurant",
                totalPoints: 61,
                questions: [
                    {
                        id: "IR1",
                        question: "IR1-US Cleanliness: What areas must be clean in the restaurant interior?",
                        points: 3,
                        options: [
                            "Just the dining tables",
                            "Floors, dining room windows, beverage bar, lobby seating/tables, PlayPlace, trash receptacles, visible kitchen areas, and dining area",
                            "Only the customer areas",
                            "Kitchen doesn't need to be clean"
                        ],
                        correct: 1,
                        explanation: "All interior areas must be clean: floors, windows, beverage bar, seating/tables, PlayPlace, trash receptacles, visible kitchen, and dining areas."
                    },
                    {
                        id: "IR2",
                        question: "IR2-US Cleanliness: What restroom standards must be met?",
                        points: 3,
                        options: [
                            "Just clean toilets",
                            "Clean, stocked, and in working order (walls, floors, sinks, hand dryers, mirrors, toilets, baby changers, all functioning, fully stocked)",
                            "Stocked with paper only",
                            "Cleanliness only matters"
                        ],
                        correct: 1,
                        explanation: "Restrooms must be clean, stocked, and in working order. All fixtures functional and stocked with toilet paper, soap, paper towels, etc."
                    },
                    {
                        id: "IR3",
                        question: "IR3-US Cleanliness: What is the employee uniform standard?",
                        points: 3,
                        options: [
                            "Any clothing",
                            "Clean and in good condition (not dirty, stained, wrinkled, or torn)",
                            "Only the shirt matters",
                            "Stains are acceptable"
                        ],
                        correct: 1,
                        explanation: "Employee uniforms must be clean and in good condition - not dirty, stained, wrinkled, or torn/ripped."
                    },
                    {
                        id: "IR4",
                        question: "IR4-US Order & Pay: What must Front Counter order takers do?",
                        points: 4,
                        options: [
                            "Just take the order",
                            "Provide digital prompt, use customer's name, be friendly, answer questions, provide clear instructions, and know how to process rewards",
                            "Only process payment",
                            "Just be friendly"
                        ],
                        correct: 1,
                        explanation: "Front Counter must: provide digital prompt, use name, be friendly, answer questions, not interrupt, provide clear instructions, know rewards/mobile orders, and provide receipt."
                    },
                    {
                        id: "IR4-Kiosk",
                        question: "IR4-US Order & Pay: What kiosk standards must be met?",
                        points: 4,
                        options: [
                            "Just needs to be powered on",
                            "Kiosk must be in full working order with table tents, product outages managed correctly, receipt printer working",
                            "Table tents are optional",
                            "Product outages don't need management"
                        ],
                        correct: 1,
                        explanation: "Kiosk must be in full working order, have table tents available, manage product outages correctly, and have working receipt printer."
                    },
                    {
                        id: "IR5",
                        question: "IR5-US Present: What must the presenter do?",
                        points: 4,
                        options: [
                            "Just hand over food",
                            "Be friendly, greet/thank customer, provide farewell, and for table service: check customer has everything needed with condiments readily available",
                            "Only say thank you",
                            "Condiments don't matter"
                        ],
                        correct: 1,
                        explanation: "Presenter must greet/thank customer, be friendly, provide farewell. Table Service: check customer has everything, have condiments readily available."
                    },
                    {
                        id: "IR6",
                        question: "IR6-US Dining Area: What hospitality standards are expected?",
                        points: 4,
                        options: [
                            "Just keep area clean",
                            "Genuine hospitality: prioritize/assist customers, actively look for connection opportunities, friendly/polite tone, smile/eye contact, effective communication",
                            "Customer interaction is optional",
                            "Just maintain distance"
                        ],
                        correct: 1,
                        explanation: "Show genuine hospitality: prioritize customer assistance, actively seek connection opportunities, friendly/polite tone, smile/eye contact, communicate effectively."
                    },
                    {
                        id: "IR7",
                        question: "IR7-US Speed: What is the Wait Time standard?",
                        points: 4,
                        options: [
                            "60 seconds or less",
                            "90 seconds or less",
                            "120 seconds or less",
                            "No time limit"
                        ],
                        correct: 1,
                        explanation: "Wait Time should be 90 seconds or less (from joining line to arrival at order point)."
                    },
                    {
                        id: "IR8a",
                        question: "IR8a Speed: What is the R2P (Receipt to Present) standard for non-table service?",
                        points: 8,
                        options: [
                            "60 seconds",
                            "90 seconds or less",
                            "120 seconds",
                            "150 seconds"
                        ],
                        correct: 1,
                        explanation: "R2P for non-table service should be 90 seconds or less (from receipt to order presented)."
                    },
                    {
                        id: "IR8b",
                        question: "IR8b Speed: What is the combined R2P and Fulfillment Time for Table Service?",
                        points: 8,
                        options: [
                            "90 seconds",
                            "120 seconds",
                            "135 seconds or less",
                            "150 seconds"
                        ],
                        correct: 2,
                        explanation: "Table Service combined R2P and Fulfillment Time should be 135 seconds or less (from receipt to full order presented including condiments)."
                    },
                    {
                        id: "IR9",
                        question: "IR9-US Accuracy: What defines accurate order fulfillment?",
                        points: 8,
                        options: [
                            "Just the main item correct",
                            "All food and drink items received as ordered and properly prepared",
                            "Close is good enough",
                            "Only food items matter"
                        ],
                        correct: 1,
                        explanation: "All food and drink items must be received as ordered AND properly prepared (correct ingredients, not underfilled). Don't penalize for upgrades at no cost."
                    },
                    {
                        id: "IR9-01",
                        question: "IR9-US-01 Accuracy: What is required for Table Service drinks?",
                        points: 2,
                        options: [
                            "Empty cup is fine",
                            "Must provide filled drink (or cup for Freestyle)",
                            "Customer fills their own always",
                            "Drinks are optional"
                        ],
                        correct: 1,
                        explanation: "Table Service must provide filled drinks. For Freestyle units, cup presented with order so customer can choose. Applies to table service only."
                    },
                    {
                        id: "IR10",
                        question: "IR10-US Accuracy: What condiments and supplies must be provided?",
                        points: 4,
                        options: [
                            "Just napkins",
                            "Condiments (if required/requested), utensils, napkins, and straws",
                            "Whatever is convenient",
                            "Only what customer specifically asks for"
                        ],
                        correct: 1,
                        explanation: "Must provide: napkins, straws, utensils, and condiments if required/requested. Note: Some municipalities require condiments to be requested."
                    },
                    {
                        id: "IR11",
                        question: "IR11-US Quality: What are sandwich/entr√©e quality standards?",
                        points: 6,
                        options: [
                            "Just hot temperature",
                            "Neat, proper temperature, fresh, tastes good, with proper bun/protein/ingredient quality and distribution",
                            "Appearance doesn't matter",
                            "Temperature only"
                        ],
                        correct: 1,
                        explanation: "Must be neat, proper temperature, fresh, taste good. Includes proper bun quality, protein tenderness/juiciness, fresh vegetables, well-distributed ingredients."
                    },
                    {
                        id: "IR12",
                        question: "IR12-US Quality: What are the french fry/hash brown standards?",
                        points: 4,
                        options: [
                            "Just cooked",
                            "Hot, salted (fries), crisp, taste good with fresh potato flavor",
                            "Temperature doesn't matter",
                            "Crispness is optional"
                        ],
                        correct: 1,
                        explanation: "Fries/hash browns must be hot, properly salted (fries), crisp, taste good with fresh potato flavor and meet McDonald's standards."
                    },
                    {
                        id: "IR13",
                        question: "IR13-US Quality: What are beverage quality standards?",
                        points: 2,
                        options: [
                            "Any temperature",
                            "Neat, proper temperature, tastes good (cold drinks must be cold/with ice), not expired",
                            "Appearance doesn't matter",
                            "Ice is optional"
                        ],
                        correct: 1,
                        explanation: "Beverages must be neat, proper temperature, taste good. Cold drinks must be cold with ice where applicable. Must not be expired. Don't order bottled water."
                    },
                    {
                        id: "IR14",
                        question: "IR14-US-02 Quality: What are dessert standards?",
                        points: 2,
                        options: [
                            "Just serve it",
                            "Neat, proper temperature, tastes good, within holding time (not expired)",
                            "Temperature doesn't matter",
                            "Appearance is not important"
                        ],
                        correct: 1,
                        explanation: "Desserts must be neat, proper temperature, taste good, and within holding time (not expired/not overheld)."
                    }
                ]
            },
            curbside: {
                title: "Curbside",
                totalPoints: 52,
                questions: [
                    {
                        id: "CU1",
                        question: "CU1-US Cleanliness: What exterior areas must be clean for Curbside?",
                        points: 3,
                        options: [
                            "Just the parking spaces",
                            "Parking lot, landscape, sidewalks, trash receptacles, corral area, and curbside signage all clean and litter-free",
                            "Only the curbside area",
                            "Signage doesn't need cleaning"
                        ],
                        correct: 1,
                        explanation: "Must be clean and litter-free: parking lot, landscape, sidewalks, trash receptacles, corral area, and curbside signage."
                    },
                    {
                        id: "CU2",
                        question: "CU2-US Cleanliness: What is the crew uniform standard?",
                        points: 3,
                        options: [
                            "Any work clothes",
                            "Clean and in good condition (not dirty, stained, wrinkled, or torn)",
                            "Only the shirt matters",
                            "Minor stains acceptable"
                        ],
                        correct: 1,
                        explanation: "Crew uniforms must be clean and in good condition - not dirty, stained, wrinkled, or torn/ripped."
                    },
                    {
                        id: "CU3",
                        question: "CU3-US Messaging: What Curbside signage/space requirements must be met?",
                        points: 4,
                        options: [
                            "Just one space needed",
                            "Spaces clearly signposted, easily identifiable, positioned near entrance, minimum two spaces, sequential numbering, differentiated from Drive Thru/Delivery",
                            "Signage is optional",
                            "Location doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Curbside spaces must be: clearly signposted, easily identifiable, near entrance doors, minimum TWO spaces, sequential numbering (1,2), differentiated from DT/Delivery."
                    },
                    {
                        id: "CU4",
                        question: "CU4-US Present: What must the Curbside presenter do?",
                        points: 4,
                        options: [
                            "Just deliver the food",
                            "Greet customer by name, be friendly, thank customer, and provide farewell",
                            "Name is not important",
                            "Just hand over the order"
                        ],
                        correct: 1,
                        explanation: "Presenter must: greet customer BY NAME, be friendly, thank customer, and provide a farewell."
                    },
                    {
                        id: "CU4-01",
                        question: "CU4-US-01 Present: What else must the Curbside presenter have/do?",
                        points: 4,
                        options: [
                            "Nothing else required",
                            "Have condiments readily available (apron/cart/tray/caddy), ask if customer has everything needed, wear high visibility safety vest",
                            "Condiments can be forgotten",
                            "Safety vest is optional"
                        ],
                        correct: 1,
                        explanation: "Must: have condiments readily available (in apron/cart/tray/caddy), check customer has everything needed, and wear HIGH VISIBILITY SAFETY VEST per requirements."
                    },
                    {
                        id: "CU5",
                        question: "CU5-US Speed: What is the Curbside service time standard (R2P + Fulfillment)?",
                        points: 8,
                        options: [
                            "90 seconds",
                            "120 seconds",
                            "135 seconds or less for 8 points",
                            "No time standard"
                        ],
                        correct: 2,
                        explanation: "Service time should be 135 seconds or less for full 8 points (starts when bay number entered and 'Done' clicked, ends when last item presented). Tiered scoring applies."
                    },
                    {
                        id: "CU6",
                        question: "CU6-US Accuracy: What defines accurate Curbside order fulfillment?",
                        points: 8,
                        options: [
                            "Just the main items",
                            "All food and drink items received as ordered and properly prepared",
                            "Close enough works",
                            "Only sandwiches matter"
                        ],
                        correct: 1,
                        explanation: "All food and drink items must be received as ordered AND properly prepared (correct ingredients, not underfilled). Don't penalize for no-cost upgrades."
                    },
                    {
                        id: "CU7",
                        question: "CU7-US Accuracy: What condiments/supplies must be included?",
                        points: 4,
                        options: [
                            "Just napkins",
                            "Condiments (if required/requested), utensils, napkins, and straws",
                            "Whatever is available",
                            "Only requested items"
                        ],
                        correct: 1,
                        explanation: "Must include: napkins, straws, utensils, and condiments if required/requested. Note: Some municipalities require condiments to be requested."
                    },
                    {
                        id: "CU8",
                        question: "CU8-US Quality: What are sandwich/entr√©e quality standards for Curbside?",
                        points: 6,
                        options: [
                            "Just needs to be warm",
                            "Neat, proper temperature, fresh, tastes good, with proper bun/protein/ingredient quality",
                            "Temperature doesn't matter",
                            "Appearance not important"
                        ],
                        correct: 1,
                        explanation: "Must be: neat, proper temperature, fresh, taste good. Includes soft/tender bun, properly toasted, tender/juicy protein, fresh vegetables, well-distributed ingredients."
                    },
                    {
                        id: "CU9",
                        question: "CU9-US Quality: What are fry/hash brown standards for Curbside?",
                        points: 4,
                        options: [
                            "Just cooked through",
                            "Hot, salted (fries), crisp, taste good with fresh potato flavor",
                            "Temperature only",
                            "Crispness optional"
                        ],
                        correct: 1,
                        explanation: "Fries/hash browns must be: hot, properly salted (fries), crisp, taste good with fresh potato flavor, meeting McDonald's standards."
                    },
                    {
                        id: "CU10",
                        question: "CU10-US Quality: What are beverage standards for Curbside?",
                        points: 2,
                        options: [
                            "Any temperature fine",
                            "Neat, proper temperature, tastes good (cold drinks cold/with ice), not expired",
                            "Ice is optional",
                            "Appearance doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Beverages must be: neat, proper temperature, taste good. Cold drinks must be cold with ice where applicable. Must not be expired. Don't order bottled water."
                    },
                    {
                        id: "CU11",
                        question: "CU11-US Quality: What are dessert standards for Curbside?",
                        points: 2,
                        options: [
                            "Just not melted",
                            "Neat, proper temperature, tastes good, within holding time (not expired)",
                            "Temperature not critical",
                            "Holding time doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Desserts must be: neat, proper temperature, taste good, and within holding time (products not expired/overheld)."
                    }
                ]
            },
            delivery: {
                title: "Delivery",
                totalPoints: 32,
                questions: [
                    {
                        id: "D7",
                        question: "D7-US Accuracy: What packaging and sealing procedures must be followed?",
                        points: 3,
                        options: [
                            "Any bag works",
                            "Rope-handled bag with proper interior bags, 3-tab stickers firmly pressed, McDelivery cup holder for drinks/desserts, not overfilled",
                            "Just seal the bag",
                            "Packaging doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Must use: rope-handled bag, proper interior bags for food, 3-tab stickers firmly pressed (no tampering), McDelivery cup holder for drinks/desserts, bags not overfilled."
                    },
                    {
                        id: "D8",
                        question: "D8-US Accuracy: What documentation must be visible on delivery orders?",
                        points: 3,
                        options: [
                            "Nothing required",
                            "Pick ticket visible and order numbers written on every bag (for multiple bags: 1 of 2, 2 of 2, etc.)",
                            "Just the receipt",
                            "Order numbers optional"
                        ],
                        correct: 1,
                        explanation: "Receipt/pick ticket must be visible and order numbers must be written on every bag. For multiple bags, number them (1 of 2, 2 of 2, etc.)."
                    },
                    {
                        id: "D9",
                        question: "D9-US Accuracy: What defines accurate delivery order fulfillment?",
                        points: 8,
                        options: [
                            "Most items correct",
                            "All food and drink items received as ordered and properly prepared",
                            "Close is acceptable",
                            "Just sandwiches need to be right"
                        ],
                        correct: 1,
                        explanation: "All food and drink items must be received as ordered AND properly prepared (correct ingredients, not underfilled). Don't penalize for no-cost upgrades. Contact 3PO if items missing."
                    },
                    {
                        id: "D10",
                        question: "D10-US Accuracy: What condiments/supplies must be in delivery orders?",
                        points: 4,
                        options: [
                            "Just napkins",
                            "Napkins, straws, utensils, requested condiments, AND ketchup with every fry order (1 small, 2 medium, 3 large)",
                            "Ketchup is optional",
                            "Whatever fits in the bag"
                        ],
                        correct: 1,
                        explanation: "Must include: napkins, straws, utensils, requested condiments. KETCHUP must be included with every fry order (1=small, 2=medium, 3=large). Some municipalities require condiments be requested."
                    },
                    {
                        id: "D11",
                        question: "D11-US Quality: What are sandwich/entr√©e quality standards for delivery?",
                        points: 6,
                        options: [
                            "Just edible",
                            "Neat, proper temperature, fresh, tastes good with proper bun/protein/ingredient quality",
                            "Temperature will drop anyway",
                            "Appearance doesn't matter for delivery"
                        ],
                        correct: 1,
                        explanation: "Must be: neat, proper temperature, fresh, taste good. Includes soft/tender bun, properly toasted, tender/juicy protein, fresh vegetables, well-distributed ingredients."
                    },
                    {
                        id: "D12",
                        question: "D12-US Quality: What are fry/hash brown standards for delivery?",
                        points: 4,
                        options: [
                            "Just warm",
                            "Proper temperature, salted (fries), taste good with fresh potato flavor and proper texture",
                            "Salt level doesn't matter",
                            "Temperature not critical"
                        ],
                        correct: 1,
                        explanation: "Fries/hash browns must be: proper temperature, properly salted (fries), taste good with fresh potato flavor and proper texture meeting McDonald's standards."
                    },
                    {
                        id: "D13",
                        question: "D13-US Quality: What are beverage standards for delivery?",
                        points: 2,
                        options: [
                            "Any condition acceptable",
                            "Neat, proper temperature, tastes good (cold drinks cold/with ice), not expired",
                            "Ice will melt anyway",
                            "Appearance doesn't matter"
                        ],
                        correct: 1,
                        explanation: "Beverages must be: neat, proper temperature, taste good. Cold drinks must be cold with ice where applicable. Must not be expired. Don't order bottled water."
                    },
                    {
                        id: "D14",
                        question: "D14-US-01 Quality: What are dessert standards for delivery?",
                        points: 2,
                        options: [
                            "Just frozen/cold items",
                            "Neat, proper temperature, tastes good, within holding time (not expired)",
                            "Temperature will change during delivery",
                            "Holding time doesn't apply"
                        ],
                        correct: 1,
                        explanation: "Desserts must be: neat, proper temperature, taste good, and within holding time (products not expired/overheld)."
                    }
                ]
            }
        };

        // Application State
        let currentUser = null;
        let currentSection = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizStartTime = null;
        let googleSheetsUrl = null;

        // Initialize
        function init() {
            loadUserData();
            showScreen('loginScreen');
        }

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.login-screen, .dashboard, .training-screen, .leaderboard-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Login
        function login() {
            const name = document.getElementById('userName').value.trim();
            const restaurant = document.getElementById('userRestaurant').value;

            if (!name || !restaurant) {
                alert('Please enter your name and select your restaurant');
                return;
            }

            currentUser = {
                name: name,
                restaurant: restaurant,
                loginTime: new Date().toISOString(),
                progress: loadUserProgress(name, restaurant)
            };

            // Automatically use the hardcoded Google Sheets URL
            if (GOOGLE_SHEETS_URL && GOOGLE_SHEETS_URL !== "PASTE_YOUR_WEB_APP_URL_HERE") {
                googleSheetsUrl = GOOGLE_SHEETS_URL;
            } else {
                googleSheetsUrl = null;
            }

            saveToLocalStorage();
            updateDashboard();
            showScreen('dashboard');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout? Your progress is saved.')) {
                currentUser = null;
                showScreen('loginScreen');
            }
        }

        // Load user progress from localStorage
        function loadUserProgress(name, restaurant) {
            const key = `cfv_${name}_${restaurant}`;
            const saved = localStorage.getItem(key);
            
            if (saved) {
                return JSON.parse(saved);
            }
            
            return {
                driveThru: { completed: false, score: 0, answers: [], lastAttempt: null },
                inRestaurant: { completed: false, score: 0, answers: [], lastAttempt: null },
                curbside: { completed: false, score: 0, answers: [], lastAttempt: null },
                delivery: { completed: false, score: 0, answers: [], lastAttempt: null }
            };
        }

        // Save to localStorage
        function saveToLocalStorage() {
            if (currentUser) {
                const key = `cfv_${currentUser.name}_${currentUser.restaurant}`;
                localStorage.setItem(key, JSON.stringify(currentUser.progress));
                localStorage.setItem('cfv_currentUser', JSON.stringify({
                    name: currentUser.name,
                    restaurant: currentUser.restaurant
                }));
            }
        }

        // Load user data on page load
        function loadUserData() {
            const savedUser = localStorage.getItem('cfv_currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                document.getElementById('userName').value = userData.name;
                document.getElementById('userRestaurant').value = userData.restaurant;
            }
        }

        // Update Dashboard
        function updateDashboard() {
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            const restaurantBadge = document.getElementById('dashboardRestaurant');
            restaurantBadge.textContent = currentUser.restaurant;
            restaurantBadge.className = `restaurant-badge restaurant-${currentUser.restaurant.toLowerCase()}`;

            // Show sync status
            const syncStatus = document.getElementById('syncStatus');
            if (googleSheetsUrl) {
                syncStatus.innerHTML = '<div class="alert alert-success">‚úÖ Connected to Google Sheets - Your scores will be automatically synced</div>';
            } else {
                syncStatus.innerHTML = '<div class="info-box">üí° Tip: Ask your manager for the Google Sheets URL to sync your scores to the cloud</div>';
            }

            // Calculate statistics
            const sections = ['driveThru', 'inRestaurant', 'curbside', 'delivery'];
            let completedCount = 0;
            let totalScore = 0;
            let scoreCount = 0;

            sections.forEach(section => {
                const progress = currentUser.progress[section];
                const progressBar = document.getElementById(`progress-${section}`);
                const scoreDisplay = document.getElementById(`score-${section}`);

                if (progress.completed) {
                    completedCount++;
                    totalScore += progress.score;
                    scoreCount++;
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    
                    const passed = progress.score >= 80;
                    scoreDisplay.textContent = `${progress.score}% - ${passed ? '‚úÖ PASSED' : '‚ùå FAILED'}`;
                    scoreDisplay.style.color = passed ? '#4caf50' : '#f44336';
                } else if (progress.answers && progress.answers.length > 0) {
                    const sectionData = trainingData[section];
                    const percentComplete = Math.round((progress.answers.length / sectionData.questions.length) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    scoreDisplay.textContent = `In Progress (${progress.answers.length}/${sectionData.questions.length})`;
                    scoreDisplay.style.color = '#ff9800';
                } else {
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    scoreDisplay.textContent = 'Not Started';
                    scoreDisplay.style.color = '#999';
                }
            });

            // Update stats
            document.getElementById('sectionsCompleted').textContent = `${completedCount}/4`;
            const overallProgress = Math.round((completedCount / 4) * 100);
            document.getElementById('overallProgress').textContent = overallProgress + '%';
            
            const avgScore = scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0;
            document.getElementById('averageScore').textContent = avgScore + '%';

            // Update rank
            updateUserRank();
        }

        // Start Training
        function startTraining(section) {
            currentSection = section;
            currentQuestionIndex = 0;
            
            // Load saved progress or start fresh
            if (currentUser.progress[section].answers && currentUser.progress[section].answers.length > 0 && !currentUser.progress[section].completed) {
                if (confirm('You have saved progress. Do you want to continue where you left off?')) {
                    userAnswers = [...currentUser.progress[section].answers];
                    currentQuestionIndex = userAnswers.length;
                } else {
                    userAnswers = [];
                    currentUser.progress[section].answers = [];
                }
            } else {
                userAnswers = [];
                currentUser.progress[section] = { completed: false, score: 0, answers: [], lastAttempt: null };
            }

            quizStartTime = new Date();
            
            document.getElementById('trainingTitle').textContent = trainingData[section].title + ' Training';
            document.getElementById('totalQuestions').textContent = trainingData[section].questions.length;
            
            showQuestion();
            showScreen('trainingScreen');
        }

        // Show Question
        function showQuestion() {
            const section = trainingData[currentSection];
            const question = section.questions[currentQuestionIndex];
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            
            const progress = Math.round(((currentQuestionIndex + 1) / section.questions.length) * 100);
            const progressBar = document.getElementById('quizProgress');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';

            const container = document.getElementById('questionContainer');
            const savedAnswer = userAnswers[currentQuestionIndex];
            
            container.innerHTML = `
                <div class="question-card">
                    <h4>Question ${currentQuestionIndex + 1} of ${section.questions.length}</h4>
                    <p style="font-size: 1.1em; margin: 15px 0; color: #333;">${question.question}</p>
                    <p style="color: #666; font-size: 0.9em;">Points: ${question.points}</p>
                    <div class="options">
                        ${question.options.map((option, index) => `
                            <div class="option ${savedAnswer !== undefined && index === savedAnswer ? 'selected' : ''}" 
                                 onclick="selectAnswer(${index})">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === section.questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'inline-block';
            } else {
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';
            }
        }

        // Select Answer
        function selectAnswer(optionIndex) {
            userAnswers[currentQuestionIndex] = optionIndex;
            
            // Update UI
            document.querySelectorAll('.option').forEach((opt, idx) => {
                opt.classList.remove('selected');
                if (idx === optionIndex) {
                    opt.classList.add('selected');
                }
            });
        }

        // Navigation
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            if (userAnswers[currentQuestionIndex] === undefined) {
                alert('Please select an answer before proceeding');
                return;
            }
            
            if (currentQuestionIndex < trainingData[currentSection].questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        // Save Progress
        function saveProgress() {
            currentUser.progress[currentSection].answers = [...userAnswers];
            saveToLocalStorage();
            alert('Progress saved! You can return to this section later.');
        }

        // Submit Quiz
        function submitQuiz() {
            if (userAnswers.length !== trainingData[currentSection].questions.length) {
                alert('Please answer all questions before submitting');
                return;
            }

            // Calculate score
            const section = trainingData[currentSection];
            let earnedPoints = 0;
            let totalPoints = section.totalPoints;

            userAnswers.forEach((answer, index) => {
                if (answer === section.questions[index].correct) {
                    earnedPoints += section.questions[index].points;
                }
            });

            const percentageScore = Math.round((earnedPoints / totalPoints) * 100);
            const passed = percentageScore >= 80;

            // Save results
            currentUser.progress[currentSection] = {
                completed: true,
                score: percentageScore,
                answers: userAnswers,
                lastAttempt: new Date().toISOString(),
                earnedPoints: earnedPoints,
                totalPoints: totalPoints,
                timeSpent: Math.round((new Date() - quizStartTime) / 1000)
            };

            saveToLocalStorage();
            
            // Try to sync to Google Sheets
            if (googleSheetsUrl) {
                saveToGoogleSheets(currentSection, percentageScore, passed);
            }

            // Show results
            showResults(percentageScore, passed, earnedPoints, totalPoints);
        }

        // Save to Google Sheets
        function saveToGoogleSheets(section, score, passed) {
            if (!googleSheetsUrl) return;

            const data = {
                timestamp: new Date().toISOString(),
                name: currentUser.name,
                restaurant: currentUser.restaurant,
                section: section,
                score: score,
                passed: passed ? 'Yes' : 'No',
                earnedPoints: currentUser.progress[section].earnedPoints,
                totalPoints: currentUser.progress[section].totalPoints,
                timeSpent: currentUser.progress[section].timeSpent
            };

            // Send data to Google Apps Script
            fetch(googleSheetsUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                console.log('Data synced to Google Sheets successfully');
            })
            .catch(error => {
                console.error('Error syncing to Google Sheets:', error);
            });
        }

        // Show Results
        function showResults(score, passed, earned, total) {
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="score-display ${passed ? '' : 'fail'}">
                    <h2 style="font-size: 2em; margin-bottom: 10px;">
                        ${passed ? 'üéâ Congratulations!' : 'üìö Keep Studying!'}
                    </h2>
                    <h2>${score}%</h2>
                    <p style="font-size: 1.2em; margin: 20px 0;">
                        ${earned} out of ${total} points
                    </p>
                    <p style="font-size: 1.1em;">
                        ${passed ? 'You PASSED! Great job!' : 'You need 80% or higher to pass. Review the material and try again.'}
                    </p>
                    ${googleSheetsUrl ? '<p style="margin-top: 15px; font-size: 0.9em;">‚úÖ Score synced to Google Sheets</p>' : ''}
                </div>
                
                <h3 style="margin: 30px 0 15px 0; color: #DA291C;">Review Your Answers</h3>
                ${generateReviewHTML()}
            `;

            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
        }

        // Generate Review HTML
        function generateReviewHTML() {
            const section = trainingData[currentSection];
            
            return section.questions.map((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correct;
                
                return `
                    <div class="question-card">
                        <h4>Question ${index + 1} ${isCorrect ? '‚úÖ' : '‚ùå'}</h4>
                        <p style="margin: 10px 0;">${question.question}</p>
                        <div class="options">
                            ${question.options.map((option, optIndex) => {
                                let className = 'option';
                                if (optIndex === question.correct) className += ' correct';
                                else if (optIndex === userAnswer && !isCorrect) className += ' incorrect';
                                
                                return `
                                    <div class="${className}">
                                        ${String.fromCharCode(65 + optIndex)}. ${option}
                                        ${optIndex === question.correct ? ' ‚úì Correct' : ''}
                                        ${optIndex === userAnswer && !isCorrect ? ' ‚úó Your Answer' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${!isCorrect ? `<p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;"><strong>Explanation:</strong> ${question.explanation}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Exit Training
        function exitTraining() {
            if (confirm('Exit training? Your progress will be saved.')) {
                saveProgress();
                updateDashboard();
                showScreen('dashboard');
            }
        }

        // Show Dashboard
        function showDashboard() {
            updateDashboard();
            showScreen('dashboard');
        }

        // Show Leaderboard
        function showLeaderboard() {
            updateLeaderboard();
            showScreen('leaderboardScreen');
        }

        // Update Leaderboard
        function updateLeaderboard() {
            const filter = document.getElementById('leaderboardFilter').value;
            const sectionFilter = document.getElementById('sectionFilter').value;
            
            // Collect all user data from localStorage
            const allUsers = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('cfv_') && !key.includes('currentUser') && !key.includes('googleSheetsUrl')) {
                    const parts = key.replace('cfv_', '').split('_');
                    const name = parts.slice(0, -1).join('_');
                    const restaurant = parts[parts.length - 1];
                    const progress = JSON.parse(localStorage.getItem(key));
                    
                    // Apply restaurant filter
                    if (filter !== 'all' && restaurant !== filter) continue;
                    
                    // Calculate score based on section filter
                    let score = 0;
                    let completedSections = 0;
                    
                    if (sectionFilter === 'overall') {
                        Object.keys(progress).forEach(section => {
                            if (progress[section].completed) {
                                score += progress[section].score;
                                completedSections++;
                            }
                        });
                        score = completedSections > 0 ? Math.round(score / completedSections) : 0;
                    } else {
                        if (progress[sectionFilter] && progress[sectionFilter].completed) {
                            score = progress[sectionFilter].score;
                            completedSections = 1;
                        }
                    }
                    
                    // Calculate total completed sections
                    const totalCompleted = Object.values(progress).filter(p => p.completed).length;
                    
                    allUsers.push({
                        name: name,
                        restaurant: restaurant,
                        score: score,
                        completed: completedSections > 0,
                        totalCompleted: totalCompleted,
                        lastAttempt: getLatestAttempt(progress)
                    });
                }
            }
            
            // Sort by score (descending) and then by completion
            allUsers.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.totalCompleted - a.totalCompleted;
            });
            
            // Filter only users with scores >= 80% for leaderboard
            const qualifiedUsers = allUsers.filter(u => u.score >= 80);
            
            // Generate leaderboard HTML
            const tbody = document.getElementById('leaderboardBody');
            
            if (qualifiedUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No qualifying scores yet. Score 80% or higher to appear on the leaderboard!</td></tr>';
                return;
            }
            
            tbody.innerHTML = qualifiedUsers.map((user, index) => {
                const rank = index + 1;
                let rankBadge = `<span class="rank-badge">${rank}</span>`;
                if (rank === 1) rankBadge = `<span class="rank-badge rank-1">ü•á</span>`;
                else if (rank === 2) rankBadge = `<span class="rank-badge rank-2">ü•à</span>`;
                else if (rank === 3) rankBadge = `<span class="rank-badge rank-3">ü•â</span>`;
                
                const isCurrentUser = currentUser && user.name === currentUser.name && user.restaurant === currentUser.restaurant;
                const rowStyle = isCurrentUser ? 'background: #fff8e1; font-weight: bold;' : '';
                
                return `
                    <tr style="${rowStyle}">
                        <td>${rankBadge}</td>
                        <td>${user.name} ${isCurrentUser ? '(You)' : ''}</td>
                        <td><span class="restaurant-badge restaurant-${user.restaurant.toLowerCase()}">${user.restaurant}</span></td>
                        <td style="font-weight: bold; color: #4caf50;">${user.score}%</td>
                        <td>${user.totalCompleted}/4 sections</td>
                        <td>${formatDate(user.lastAttempt)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update User Rank
        function updateUserRank() {
            if (!currentUser) return;
            
            // Collect all users and calculate ranks
            const allUsers = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('cfv_') && !key.includes('currentUser') && !key.includes('googleSheetsUrl')) {
                    const parts = key.replace('cfv_', '').split('_');
                    const name = parts.slice(0, -1).join('_');
                    const restaurant = parts[parts.length - 1];
                    const progress = JSON.parse(localStorage.getItem(key));
                    
                    let totalScore = 0;
                    let completedCount = 0;
                    
                    Object.values(progress).forEach(section => {
                        if (section.completed) {
                            totalScore += section.score;
                            completedCount++;
                        }
                    });
                    
                    const avgScore = completedCount > 0 ? Math.round(totalScore / completedCount) : 0;
                    
                    if (avgScore >= 80) {
                        allUsers.push({ name, restaurant, score: avgScore });
                    }
                }
            }
            
            allUsers.sort((a, b) => b.score - a.score);
            
            const userIndex = allUsers.findIndex(u => 
                u.name === currentUser.name && u.restaurant === currentUser.restaurant
            );
            
            const rankDisplay = document.getElementById('userRank');
            if (userIndex >= 0) {
                rankDisplay.textContent = `#${userIndex + 1}`;
            } else {
                rankDisplay.textContent = '-';
            }
        }

        // Helper Functions
        function getLatestAttempt(progress) {
            let latest = null;
            Object.values(progress).forEach(section => {
                if (section.lastAttempt) {
                    if (!latest || new Date(section.lastAttempt) > new Date(latest)) {
                        latest = section.lastAttempt;
                    }
                }
            });
            return latest;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
